<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
      <meta name="description" content="Debugging PHP web applications using XDebug inside Docker">
      <meta name="twitter:description" content="Debugging PHP web applications using XDebug inside Docker">
    

    <meta property="og:title" content="Debugging PHP web applications using XDebug inside Docker">
    <meta property="twitter:title" content="Debugging PHP web applications using XDebug inside Docker">
    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2017-05-20">
    
    <meta property="og:description" content="">
    <meta property="og:url" content="https://tarunlalwani.in/post/debugging-php-xdebug-docker/">
    <meta property="og:site_name" content="Tech Adventures by Tarun Lalwani">
   

    
    <meta property="og:tags" content="docker">
    
    <meta property="og:tags" content="xdebug">
    
    <meta property="og:tags" content="debugging">
    
    <meta property="og:tags" content="php">
    
    <meta property="og:tags" content="debug">
    
    <meta property="og:tags" content="ssh">
    

    

    <meta name="generator" content="Hugo 0.42.1" />
    <title>Debugging PHP web applications using XDebug inside Docker &middot; Tech Adventures by Tarun Lalwani</title>
    
    <link rel="stylesheet" href="https://tarunlalwani.in/css/style.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
   <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/sunburst.min.css">

    

    
    <link href="https://tarunlalwani.in/index.xml" rel="alternate" type="application/rss+xml" title="Tech Adventures by Tarun Lalwani" />
    
    

    
    
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="https://tarunlalwani.in/">TARUN LALWANI</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="https://tarunlalwani.in/">TARUN LALWANI</a></h1>
		
		
		
			<small class="text-center center-block">Technology Enthusiast</small>
		
		
		
			<img id="profile-pic" src="https://tarunlalwani.in//images/profile.png" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			<a href="https://twitter.com/ask4tarun"><i class="fa fa-twitter fa-2x"></i></a>
			<a href="https://plus.google.com/&#43;TarunLalwani"><i class="fa fa-google-plus fa-2x"></i></a>
			<a href="https://www.linkedin.com/in/tarunlalwani"><i class="fa fa-linkedin fa-2x"></i></a>
			<a href="https://github.com/tarunlalwani"><i class="fa fa-github fa-2x"></i></a>
			
		</div>
		<div id="links" class="text-center">
			
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<h1>Debugging PHP web applications using XDebug inside Docker</h1>
	</header>

	<article>
		

<p>Debugging is an important aspect of any test environment. It helps developer troubleshoot their code on a deployed environment.</p>

<p><a href="https://xdebug.org/">XDebug</a> is one of the popular debuggers for PHP and many PHP IDEs have built-in support for XDebug.</p>

<p>Docker provides official images for <code>php-fpm</code> and <code>nginx</code>. <code>php-fpm</code> process all the PHP code and for client request handling we will use nginx.</p>

<p>In this article we will explore 2 approaches for using XDebug in a php-fpm + Nginx setup. Before we dive into these approaches, we first need to see how to setup a simple version</p>

<h2 id="setting-up-nginx-and-php-fpm">Setting up Nginx and PHP-FPM</h2>

<p>We first write a <code>docker-compose.yml</code> file</p>

<pre><code class="language-yaml">version: '2'
services:
  nginx:
    image: nginx:latest
    volumes:
      - ./app.conf:/etc/nginx/conf.d/app.conf
      - ./php_testapp:/var/www/html
    ports:
      - &quot;8080:80&quot;
  php-fpm:
    image: php-fpm:5.6-fpm
    volumes:
      - ./php_testapp:/var/www/html
</code></pre>

<p>The <code>php_testapp</code> folder has a simple <code>index.php</code></p>

<h4 id="php-testapp-index-php">php_testapp/index.php</h4>

<pre><code class="language-php">&lt;?php
phpinfo();
</code></pre>

<h4 id="app-conf">app.conf</h4>

<pre><code class="language-nginx">server {
    index index.php index.html;
    server_name _;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/html;

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
}
</code></pre>

<p>We get the environment up and running using <code>docker-compose up -d</code> and then browse to <code>http://&lt;dockerhost&gt;:8080/</code> to test our setup. If all works well you will see a PHP Info page</p>

<p>Now let us look at both the approaches one by one</p>

<h2 id="approach-1-using-fixed-ip">Approach 1 - Using Fixed IP</h2>

<p>First we need to install XDebug into the <code>php-fpm</code> image as it doesn&rsquo;t come as a part of the official image</p>

<h4 id="dockerfile">Dockerfile</h4>

<pre><code class="language-Dockerfile">FROM php:5.6-fpm
RUN pecl install xdebug-2.5.3 \
    &amp;&amp; docker-php-ext-enable xdebug

COPY 99-xdebug.ini /usr/local/etc/php/conf.d/
</code></pre>

<p>We add <code>99-xdebug.ini</code> which contains settings for XDebug</p>

<h4 id="99-xdebug-ini">99-xdebug.ini</h4>

<pre><code class="language-ini">xdebug.remote_enable=0
xdebug.remote_host=remotehost
xdebug.remote_handler=dbgp
xdebug.remote_port=9009
xdebug.remote_autostart=0
xdebug.remote_log=/tmp/xdebug.log
</code></pre>

<blockquote>
<p>Note: The official port for XDebug is <code>9000</code>, but since we are running <code>php-fpm</code> which also runs on 9000 port, I prefer running XDebug on <code>9009</code></p>
</blockquote>

<p>Now we update our <code>app.conf</code> to update some of the XDebug settings through <code>fastcgi_param</code></p>

<h4 id="app-conf-1">app.conf</h4>

<pre><code>server {
    index index.php index.html;
    server_name _;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/html;

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        fastcgi_param PHP_VALUE &quot;xdebug.remote_autostart=1
        xdebug.remote_enable=1
        xdebug.remote_host=192.168.0.104&quot;;
    }
}
</code></pre>

<p>We would also update our <code>docker-compose.yml</code> to build our <code>Dockerfile</code> instead of using the official image</p>

<pre><code class="language-yaml">version: '2'
services:
  nginx:
    image: nginx:latest
    volumes:
      - ./app.conf:/etc/nginx/conf.d/app.conf
      - ./php_testapp:/var/www/html
    ports:
      - &quot;8080:80&quot;
  php-fpm:
    build: .
    volumes:
      - ./php_testapp:/var/www/html
</code></pre>

<p><code>192.168.0.104</code> in this case is my machine&rsquo;s IP. This IP needs to be reachable from the main docker host machine</p>

<p>We have enabled <code>remote_autostart</code> and <code>remote_enable</code> through Nginx config instead in our docker image using <code>99-xdebug.ini</code>. Doing so gives us better control over switching XDebug on and off.</p>

<p>Since we may debug from different network setup (home, office), the IP would need to be changed according to the network. This would require a reload or restart of the nginx server using <code>docker-compose restart nginx</code></p>

<p>This approach is very simplistic, doesn&rsquo;t have much overhead, except updating IP.</p>

<h2 id="approach-2-using-ssh-and-reverese-tunneling">Approach 2 - Using SSH and Reverese Tunneling</h2>

<p>In this approach we first setup ssh in the <code>php-fpm</code> image. Since we will be running <code>sshd</code>
and <code>php-fpm</code> both, we would run them using <a href="http://supervisord.org/">Supervisor</a></p>

<p>First thing we do is update our <code>Dockerfile</code> to install ssh and set password for our root account. The code is inspired from <a href="https://docs.docker.com/engine/examples/running_ssh_service/">here</a></p>

<h4 id="dockerfile-1">Dockerfile</h4>

<pre><code class="language-Dockerfile">FROM php:5.6-fpm
RUN pecl install xdebug-2.5.3 \
    &amp;&amp; docker-php-ext-enable xdebug

COPY 99-xdebug.ini /usr/local/etc/php/conf.d/

RUN apt update &amp;&amp; apt install -y openssh-server supervisor
RUN mkdir /var/run/sshd
RUN sed -i -e 's/PermitRootLogin without-password/PermitRootLogin yes/' -e '/AuthorizedKeysFile/s/^# *//' -e '/UsePrivilegeSeparation/s/yes/no/' /etc/ssh/sshd_config
RUN echo 'root:mypassword' | chpasswd

#RUN mkdir /root/.ssh &amp;&amp; ssh-keygen -t rsa -P &quot;&quot; -C &quot;SSH Client Key for XDebug&quot; -f /root/.ssh/xdebug_client &amp;&amp; cat /root/.ssh/xdebug_client.pub &gt;&gt; /root/.ssh/authorized_keys
COPY supervisor_app.conf /etc/supervisor/conf.d/
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
EXPOSE 80 443 22
CMD [&quot;supervisord&quot;, &quot;-n&quot;]
</code></pre>

<blockquote>
<p>Note: It is possible to use key based authentication instead of password based. I have left the code commented, if you are interested to do the same</p>
</blockquote>

<p>To run <code>php-fpm</code> and <code>sshd</code> we also create a <code>supervisor_app.conf</code></p>

<h4 id="supervisor-app-conf">supervisor_app.conf</h4>

<pre><code class="language-ini">[program:php-fpm]
command=php-fpm

[program:sshd]
command=/usr/sbin/sshd -D
</code></pre>

<h4 id="docker-compose-yml">docker-compose.yml</h4>

<p>We make a small change in our <code>docker-compose.yml</code> to map <code>22</code> port</p>

<pre><code class="language-yaml">version: '2'
services:
  nginx:
    image: nginx:latest
    volumes:
      - ./app.conf:/etc/nginx/conf.d/app.conf
      - ./php_testapp:/var/www/html
    ports:
      - &quot;8080:80&quot;
  php-fpm:
    build: .
    volumes:
      - ./php_testapp:/var/www/html
    ports:
      - &quot;2222:22&quot;
</code></pre>

<p>We also update our nginx <code>app.conf</code> file and change the <code>xdebug.remote_host</code> to <code>localhost</code></p>

<h4 id="app-conf-2">app.conf</h4>

<pre><code class="language-nginx">server {
    index index.php index.html;
    server_name _;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/html;

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        fastcgi_param PHP_VALUE &quot;xdebug.remote_autostart=1
        xdebug.remote_enable=1
        xdebug.remote_host=localhost&quot;;
    }
}
</code></pre>

<p>Now that we have everything set, we just need to run the composition again using <code>docker-compose up -d</code>.</p>

<p>The reason we set <code>xdebug.remote_host</code> as localhost is that we would use SSH reverse tunnel to map any traffic on port <code>9009</code> of our docker container to reach our machine directly.</p>

<p>To create a reverse ssh tunnel, run the below command</p>

<pre><code class="language-bash">ssh -R 127.0.0.1:9009:127.0.0.1:9009 -p 2222 root@&lt;dockerhostip&gt;
</code></pre>

<blockquote>
<p>Note: The password in our case is <code>mypassword</code></p>
</blockquote>

<p>Once the tunnel is open, if you configure your IDE to listen on port <code>9009</code> and open the url <code>http://&lt;dockerhostip&gt;:8080/</code> on your machine, the debugger should pause on <code>index.php</code> code as shown below</p>

<blockquote>
<p>Note: This is not a recommended approach for production deployments. You don&rsquo;t want to allow SSH inside containers in a prod environment.
Anyways if you are debugging on production, then it really doesn&rsquo;t make much sense. But sometimes that may be the need of hour, in that case use Approach 1.
This approach is best suited where multiple developers would be debugging the code and changing IP everytime might be a pain</p>
</blockquote>

<p><img style="width: 100%;" src="../../images/xdebug_php_code.png" alt="PHPStorm XDebug Session">
</img></p>

<p>You can download the code for this article from <a href="https://github.com/tarunlalwani/php-xdebug-docker">tarunlalwani/php-xdebug-docker</a></p>

	</article>
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" https://tarunlalwani.in/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>


  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'tarunlalwani';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



						</div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-99088991-1', 'auto');
    ga('send', 'pageview');
    window.baseURL = "https:\/\/tarunlalwani.in\/";
  </script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  
  
  

  <script src="https://tarunlalwani.in//js/highlight.pack.js"></script>
  
  <script src="https://tarunlalwani.in//js/App.js"></script>
  
</body>
</html>
