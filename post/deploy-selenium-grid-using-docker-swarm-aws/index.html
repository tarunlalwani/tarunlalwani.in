<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
      <meta name="description" content="Learn how to Deploy a Selenium Grid on AWS using Docker Swarm">
      <meta name="twitter:description" content="Learn how to Deploy a Selenium Grid on AWS using Docker Swarm">
    

    <meta property="og:title" content="AWS Docker Swarm - Deploying a Selenium grid">
    <meta property="twitter:title" content="AWS Docker Swarm - Deploying a Selenium grid">
    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2017-07-06">
    
    <meta property="og:description" content="Learn how to Deploy a Selenium Grid on AWS using Docker Swarm">
    <meta property="og:url" content="http://tarunlalwani.com/post/deploy-selenium-grid-using-docker-swarm-aws/">
    <meta property="og:site_name" content="Tech Adventures by Tarun Lalwani">
   

    
    <meta property="og:tags" content="selenium">
    
    <meta property="og:tags" content="grid">
    
    <meta property="og:tags" content="docker">
    
    <meta property="og:tags" content="swarm">
    
    <meta property="og:tags" content="aws">
    

    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@ask4tarun">
    <meta property="og:image" content="http://tarunlalwani.com/images/docker_swarm_aws.png">
    <meta property="twitter:image" content="http://tarunlalwani.com/images/docker_swarm_aws.png">
    

    <meta name="generator" content="Hugo 0.42.1" />
    <title>AWS Docker Swarm - Deploying a Selenium grid &middot; Tech Adventures by Tarun Lalwani</title>
    
    <link rel="stylesheet" href="http://tarunlalwani.com/css/style.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
   <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/sunburst.min.css">

    

    
    <link href="http://tarunlalwani.com/index.xml" rel="alternate" type="application/rss+xml" title="Tech Adventures by Tarun Lalwani" />
    
    

    
    
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://tarunlalwani.com/">TARUN LALWANI</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="http://tarunlalwani.com/">TARUN LALWANI</a></h1>
		
		
		
			<small class="text-center center-block">Technology Enthusiast</small>
		
		
		
			<img id="profile-pic" src="http://tarunlalwani.com//images/profile.png" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			<a href="https://twitter.com/ask4tarun"><i class="fa fa-twitter fa-2x"></i></a>
			<a href="https://plus.google.com/&#43;TarunLalwani"><i class="fa fa-google-plus fa-2x"></i></a>
			<a href="https://www.linkedin.com/in/tarunlalwani"><i class="fa fa-linkedin fa-2x"></i></a>
			<a href="https://github.com/tarunlalwani"><i class="fa fa-github fa-2x"></i></a>
			
		</div>
		<div id="links" class="text-center">
			
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<h1>AWS Docker Swarm - Deploying a Selenium grid</h1>
	</header>

	<article>
		

<p>Selenium Grid helps us to group multiple machines as worker nodes to provide browsers for our  tests. To run multiple tests in parallel grid is a must.</p>

<p>With Docker Swarm it becomes easy to create dynamic grid, which can be scaled on need. This article will walk you through setting up a Grid on AWS using 3 machines (1 manager, 2 worker node). The minimum recommeded setup is of 5 machines at least (3 manager, 2 worker nodes).</p>

<p>By default in a Docker Swarm even the master nodes participate as worker. Until unless required, master nodes shouldn&rsquo;t be used for deploying workloads. In our demo also we won&rsquo;t deploy hub or nodes to any of the manager nodes.</p>

<h2 id="creating-the-docker-swarm-security-group">Creating the Docker SWARM security Group</h2>

<p>Docker Swarm requires few ports to be open for it to work. These are</p>

<ul>
<li>TCP port 2377. This port is used for communication between the nodes of a Docker Swarm or cluster. It only needs to be opened on manager nodes.</li>
<li>TCP and UDP port 7946 for communication among nodes (container network discovery).</li>
<li>UDP port 4789 for overlay network traffic (container ingress networking).</li>
</ul>

<p>So first create a group that has all these ports whitelisted</p>

<p><img src="../../images/docker_swarm_security_group.png" style="width: 100%" alt="Docker Swarm Security Group" /></p>

<h2 id="creating-the-base-machines-on-aws">Creating the Base Machines on AWS</h2>

<p>Create 3 machines of <code>t2.micro</code> instance type and choose <code>Ubuntu Server 16.04 LTS (HVM), SSD Volume Type</code> as the OS. We will be using ubuntu so that latest version of Docker can be installed. Make sure to attach the <code>Docker Swarm</code> security we created earlier</p>

<p>First install docker on all 3 machines</p>

<pre><code class="language-bash">$ curl -SsL https://get.docker.com | sh
</code></pre>

<p>This will install the latest version of Docker. Then add the ubuntu user to the docker group, so we don&rsquo;t need to use sudo everytime we use the docker command</p>

<pre><code class="language-bash">$ sudo usermod -aG docker ubuntu
</code></pre>

<h2 id="setting-up-the-firewall">Setting up the Firewall</h2>

<pre><code class="language-bash">$ sudo ufw status
Status: inactive
</code></pre>

<p>If you get active as the output of above command then you need to either configure the firewall or disable it</p>

<h4 id="disabling-the-firewall">Disabling the firewall</h4>

<pre><code class="language-bash">$ sudo ufw disable
</code></pre>

<p>The above will disable the firewall</p>

<h4 id="configuring-the-firewall">Configuring the firewall</h4>

<p>If you prefer to configure the firewall then use the below set of commands</p>

<pre><code class="language-bash">$ sudo ufw allow 22/tcp
$ sudo ufw allow 2377/tcp
$ sudo ufw allow 7946/tcp
$ sudo ufw allow 7946/udp
$ sudo ufw allow 4789/udp
$ sudo ufw allow 4444/tcp
</code></pre>

<p>For more details on setting up the firewall correctly on your setup, refer to this <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-the-linux-firewall-for-docker-swarm-on-ubuntu-16-04">article</a></p>

<h2 id="setting-up-the-swarm-master">Setting up the SWARM master</h2>

<p>Choose one machine as the master machine and initiate Docker Swarm mode on the same</p>

<pre><code class="language-bash">$ docker swarm init
Swarm initialized: current node (deyp099wnn94lgauxp9ljil83) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-5rm2sib935txv5k13j6leaqsfuuttalktt7jv4s55249izjf54-8ia31tagc4sbehqeqiqst4jfz 172.30.0.170:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
</code></pre>

<p>Now on the other two machines execute the join the command</p>

<pre><code class="language-bash">$ docker swarm join --token SWMTKN-1-5rm2sib935txv5k13j6leaqsfuuttalktt7jv4s55249izjf54-8ia31tagc4sbehqeqiqst4jfz 172.30.0.170:2377
This node joined a swarm as a worker.
</code></pre>

<p>Once done execute the <code>docker info</code> command on master node</p>

<pre><code class="language-bash">$ docker info
...
Swarm: active
 NodeID: deyp099wnn94lgauxp9ljil83
 Is Manager: true
 ClusterID: ujst6yr4orqiyago1u277pppp
 Managers: 1
 Nodes: 3
...
</code></pre>

<p>If everything worked, you will see <code>Swarm: active</code> and <code>Nodes: 3</code> in the output (3 because even manager is one of the nodes)</p>

<h2 id="creating-the-selenium-grid">Creating the Selenium Grid</h2>

<p>Next we create Docker stack compatible compose file. I will show the complete file first and then talk about small details which need attention</p>

<h4 id="grid-yaml">grid.yaml</h4>

<pre><code class="language-yaml">version: &quot;3&quot;

networks:
  main:
    driver: overlay
services:
  hub:
    image: selenium/hub:3.2.0
    ports:
      - &quot;4444:4444&quot;
    networks:
      - main
    deploy:
      mode: replicated
      replicas: 1
      labels:
        selenium.grid.type: &quot;hub&quot;
        selenium.grid.hub: &quot;true&quot;
      restart_policy:
        condition: none
      placement:
        constraints: [node.role == worker]
  chrome:
    image: selenium/node-chrome
    entrypoint: &gt;
      bash -c '
        export IP_ADDRESS=$$(ip addr show eth0 | grep &quot;inet\b&quot; | awk '&quot;'&quot;'{print $$2}'&quot;'&quot;' | awk -F/ '&quot;'&quot;'{print $$1}'&quot;'&quot;' | head -1) &amp;&amp;
        SE_OPTS=&quot;-host $$IP_ADDRESS&quot; /opt/bin/entry_point.sh'
    volumes:
      - /dev/urandom:/dev/random
      - /dev/shm:/dev/shm
    environment:
      HUB_PORT_4444_TCP_ADDR: hub
      HUB_PORT_4444_TCP_PORT: 4444
      NODE_MAX_SESSION: 1
    networks:
      - main
    deploy:
      mode: replicated
      replicas: 2
      labels:
        selenium.grid.type: &quot;node&quot;
        selenium.grid.node: &quot;true&quot;
        selenium.grid.node.type: &quot;chrome&quot;
      restart_policy:
        condition: none
      placement:
        constraints: [node.role == worker]
  firefox:
    image: selenium/node-firefox
    entrypoint: &gt;
      bash -c '
        export IP_ADDRESS=$$HOSTNAME &amp;&amp;
        SE_OPTS=&quot;-host $$IP_ADDRESS&quot; /opt/bin/entry_point.sh'
    volumes:
      - /dev/shm:/dev/shm
      - /dev/urandom:/dev/random
    environment:
      HUB_PORT_4444_TCP_ADDR: hub
      HUB_PORT_4444_TCP_PORT: 4444
      NODE_MAX_SESSION: 1
    networks:
      - main
    depends_on:
      - hub
    deploy:
      mode: replicated
      replicas: 2
      labels:
        selenium.grid.type: &quot;node&quot;
        selenium.grid.node: &quot;true&quot;
        selenium.grid.node.type: &quot;firefox&quot;
      restart_policy:
        condition: none
      placement:
        constraints: [node.role == worker]
</code></pre>

<h4 id="selenium-version">Selenium version</h4>

<p>I have used <code>image: selenium/hub:3.2.0</code> for this demo instead of the latest one. Why? This is because of an issue in the latest version of grid. The discussion about the issue can be followed on <a href="https://github.com/SeleniumHQ/selenium/issues/3808">#3808 Grid does not handle w3c capabilities correctly</a>.</p>

<h4 id="port-mapping">Port mapping</h4>

<p>We have exposed the <code>ports</code> as <code>4444:4444</code> which basically means one can connect to the grid on port <code>4444</code> on any node in the Swarm network. But we have not done this for the nodes as we don&rsquo;t want to expose individual nodes on the Swarm nodes.</p>

<h4 id="deployment-constraints">Deployment constraints</h4>

<p>Constraint options <code>constraints: [node.role == worker]</code> allows us to place our workload on the worker node instead of the manager nodes. In case you want to run the hub on the manager node use <code>[node.role == manager]</code> as the value instead</p>

<h4 id="environment-variables">Environment variables</h4>

<p>We define two environment variables <code>HUB_PORT_4444_TCP_ADDR: hub</code> and <code>HUB_PORT_4444_TCP_PORT: 4444</code> for our nodes. This is because the selenium entrypoint script uses these environment variables. These variables were automatically created when using links in earlier version of Docker. This feature is now deprecated and the variables don&rsquo;t get created anymore. So we need to define thim</p>

<h4 id="volume-mappings">Volume mappings</h4>

<p>Volumes <code>/dev/shm</code> and <code>/dev/urandom</code> are shared from the host machine as they are necesarry for certain working of the browser. You can see more details on issues that arise if not sharing these volumes <a href="https://bugs.chromium.org/p/chromedriver/issues/detail?id=1097">session deleted because of page crash</a> and <a href="https://github.com/SeleniumHQ/docker-selenium/issues/79">node-chome tab crash in docker only</a></p>

<h4 id="entrypoint-override">Entrypoint override</h4>

<p>I have used two different approaches for overriding the entrypoints of <code>chrome</code> and <code>firefox</code> images</p>

<pre><code class="language-yaml">    # For Chrome
    entrypoint: &gt;
      bash -c '
        export IP_ADDRESS=$$(ip addr show eth0 | grep &quot;inet\b&quot; | awk '&quot;'&quot;'{print $$2}'&quot;'&quot;' | awk -F/ '&quot;'&quot;'{print $$1}'&quot;'&quot;' | head -1) &amp;&amp;
        SE_OPTS=&quot;-host $$IP_ADDRESS&quot; /opt/bin/entry_point.sh'

    # For Firefox
    entrypoint: &gt;
      bash -c '
        export IP_ADDRESS=$$HOSTNAME &amp;&amp;
        SE_OPTS=&quot;-host $$IP_ADDRESS&quot; /opt/bin/entry_point.sh'
</code></pre>

<p>The reason for using two different approaches was to showcase both methods.</p>

<p>So first of all, why do we need to override the host in <code>SE_OPTS</code>? Well the reason is that a container can have multiple interfaces and when we start <code>selenium-server.jar</code> it tries to make a guess based on the interfaces available. It then sends this address to hub to contact it back. In case of multiple interfaces the address can determined wrongly and the hub is not able to communicate back with the node.</p>

<p>To fix this issue we need to ourself determine the IP or hostname of the container.</p>

<p>So there are two approaches here, one is to use the hostname of the container. This is random and would be alphanumeric. Second approach is to use the IP address. This requires the ip command to be installed on the container image. This is available in the <code>chrome</code> image but not in <code>firefox</code> image. So the hostname approach will work in both the cases. Docker automatically creates a environment named HOSTNAME inside the running container. We use a double dollar <code>$$</code> to make sure docker doesn&rsquo;t process the environment variable while parsing our compose file</p>

<p><img src="../../images/grid_console.png" alt="Selenium Grid Console" style="width: 100%;"/></p>

<h4 id="port-4444-in-security-group">Port 4444 in Security Group</h4>

<p>Port <code>4444</code> which we published also need to opened in the Security Groups of all 3 machines</p>

<p>Those are majorly the points that were not very obvious about our compose file. So now let&rsquo;s look at deploying this stack</p>

<h2 id="deploying-the-selenium-grid">Deploying the Selenium Grid</h2>

<p>Execute the below command on the Swarm manager node</p>

<pre><code class="language-bash">$ docker stack deploy --compose-file grid.yaml grid
Creating network grid_main
Creating service grid_hub
Creating service grid_chrome
Creating service grid_firefox
</code></pre>

<p>Now we can check status of our stack using the <code>stack ps</code> command</p>

<pre><code class="language-bash">$ docker stack ps grid
ID                  NAME                IMAGE                          NODE                DESIRED STATE       CURRENT STATE              ERROR               PORTS
l8zykev3dp29        grid_firefox.1      selenium/node-firefox:latest   ip-172-30-0-23      Running             Preparing 14 seconds ago
xjrdfxyt3voc        grid_chrome.1       selenium/node-chrome:latest    ip-172-30-0-23      Running             Preparing 16 seconds ago
fyj8snygf5gs        grid_hub.1          selenium/hub:3.2.0             ip-172-30-0-69      Running             Preparing 18 seconds ago
ssbgye4iu76h        grid_firefox.2      selenium/node-firefox:latest   ip-172-30-0-69      Running             Preparing 13 seconds ago
urciuebirsr7        grid_chrome.2       selenium/node-chrome:latest    ip-172-30-0-69      Running             Preparing 16 seconds ago
</code></pre>

<h2 id="testing-the-grid">Testing the grid</h2>

<p>We will use python to test our grid. Python doesn&rsquo;t come pre-installed on the ubuntu images of AWS. So we need to first install python</p>

<pre><code class="language-bash">$ sudo apt update &amp;&amp; sudo apt install -y python python-pip
</code></pre>

<p>Once we have python, we need to install the selenium package</p>

<pre><code class="language-bash">$ pip install selenium==3.3.1
</code></pre>

<blockquote>
<p>Note: I have installed Selenium <code>3.3.1</code> version to avoid the <a href="https://github.com/SeleniumHQ/selenium/issues/3808">Issue #3808</a>. You will get an exception with below message in case you use a higher version
selenium.common.exceptions.WebDriverException: Message: None
Stacktrace: at java.util.HashMap.putMapEntries
(:-1) at java.util.HashMap.putAll
(:-1) at org.openqa.selenium.remote.DesiredCapabilities. (DesiredCapabilities.java:55)</p>
</blockquote>

<p>Once done we can execute the below commands in python</p>

<pre><code class="language-python">$ python
Python 2.7.12 (default, Nov 19 2016, 06:48:10)
[GCC 5.4.0 20160609] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from selenium import webdriver
&gt;&gt;&gt; from selenium.webdriver.common.desired_capabilities import DesiredCapabilities
&gt;&gt;&gt;
&gt;&gt;&gt; grid_url = &quot;http://127.0.0.1:4444/wd/hub&quot;
&gt;&gt;&gt; driver = webdriver.Remote(grid_url, DesiredCapabilities.FIREFOX)
&gt;&gt;&gt;
&gt;&gt;&gt; driver.get(&quot;http://tarunlalwani.com&quot;)
&gt;&gt;&gt;
&gt;&gt;&gt; driver.current_url
u'http://tarunlalwani.com/'
&gt;&gt;&gt;
</code></pre>

<p>So our grid is now working on Swarm. If you want to scale the grid nodes use the <code>scale</code> command</p>

<pre><code class="language-bash">$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                          PORTS
050nvxan3von        grid_firefox        replicated          2/2                 selenium/node-firefox:latest
no6klfawrm2h        grid_chrome         replicated          2/2                 selenium/node-chrome:latest
t33b1eqzzokt        grid_hub            replicated          1/1                 selenium/hub:3.2.0             *:4444-&gt;4444/tcp

$ docker service scale grid_chrome=4
grid_chrome scaled to 4

$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                          PORTS
050nvxan3von        grid_firefox        replicated          1/2                 selenium/node-firefox:latest
no6klfawrm2h        grid_chrome         replicated          4/4                 selenium/node-chrome:latest
t33b1eqzzokt        grid_hub            replicated          1/1                 selenium/hub:3.2.0             *:4444-&gt;4444/tcp
</code></pre>

<p>As you can see, with one we can scale our grid up and down. One can even apply Auto Scaling for adding new worker nodes based on the load.</p>

	</article>
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" http://tarunlalwani.com/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>


  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'tarunlalwani';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



						</div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-99088991-1', 'auto');
    ga('send', 'pageview');
    window.baseURL = "http:\/\/tarunlalwani.com\/";
  </script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  
  
  

  <script src="http://tarunlalwani.com//js/highlight.pack.js"></script>
  
  <script src="http://tarunlalwani.com//js/App.js"></script>
  
</body>
</html>
